name: Generate Resume Artifacts

on:
  push:
    branches: [main]
    paths:
      - 'resume.html'
      - 'style.css'
      - '.github/workflows/generate-resume.yml'

jobs:
  generate-artifacts:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # Checkout the repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Setup Node.js for Playwright (faster than installing Chromium via apt-get)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install Playwright with Chromium (bundled, no separate download needed)
      - name: Install Playwright
        run: |
          npm install -D playwright
          npx playwright install chromium --with-deps

      # Install Pandoc for HTML to Markdown conversion
      - name: Install Pandoc
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y pandoc

      # Generate PDF using Playwright with commit hash in filename
      # Playwright's bundled Chromium respects print CSS and renders faster
      - name: Generate PDF from HTML
        run: |
          # Remove old versioned PDFs from git (not just filesystem)
          # The || true ensures command doesn't fail if no old PDFs exist
          git rm -f Munevver_Aslan_Resume_*.pdf 2>/dev/null || true

          COMMIT_HASH=$(git rev-parse --short=7 HEAD)
          PDF_NAME="Munevver_Aslan_Resume_${COMMIT_HASH}.pdf"

          # Create Node.js script to generate PDF with Playwright
          cat > generate-pdf.js << 'EOF'
          const { chromium } = require('playwright');
          const fs = require('fs');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto('file://' + process.cwd() + '/resume.html', { waitUntil: 'networkidle' });
            await page.pdf({
              path: process.argv[2],
              format: 'A4',
              printBackground: true,
              margin: { top: '0.35in', right: '0.35in', bottom: '0.35in', left: '0.35in' }
            });
            await browser.close();
          })();
          EOF

          # Run the PDF generation
          node generate-pdf.js "${PDF_NAME}"

          # Export PDF name for use in subsequent steps
          echo "PDF_NAME=${PDF_NAME}" >> $GITHUB_ENV

          # Clean up the temporary script
          rm generate-pdf.js

      # Generate clean, visually organized README from resume.html
      # Creates properly formatted sections with clear visual hierarchy
      - name: Generate clean markdown README from HTML
        run: |
          # Create Python script for better HTML parsing and formatting
          cat > generate_readme.py << 'PYSCRIPT'
          from html.parser import HTMLParser
          import sys
          import os

          class ResumeParser(HTMLParser):
              def __init__(self):
                  super().__init__()
                  self.current_section = None
                  self.summary = ""
                  self.skills = {}
                  self.current_skill_category = None
                  self.first_experience = {}
                  self.in_first_exp = False
                  self.exp_count = 0
                  self.capture_text = False
                  self.current_text = ""

              def handle_starttag(self, tag, attrs):
                  attrs_dict = dict(attrs)
                  class_name = attrs_dict.get('class', '')

                  if class_name == 'summary-text':
                      self.current_section = 'summary'
                      self.capture_text = True
                  elif 'section-title' in class_name and 'Ski' in self.current_text:
                      self.current_section = 'skills'
                  elif class_name == 'skill-category':
                      self.capture_text = True
                      self.current_section = 'skill_category'
                  elif class_name == 'skill-items':
                      self.capture_text = True
                      self.current_section = 'skill_items'
                  elif class_name == 'experience-item' and self.exp_count == 0:
                      self.in_first_exp = True
                      self.exp_count += 1
                  elif self.in_first_exp:
                      if class_name == 'job-title':
                          self.capture_text = True
                          self.current_section = 'job_title'
                      elif class_name == 'company-name':
                          self.capture_text = True
                          self.current_section = 'company'
                      elif class_name == 'job-date':
                          self.capture_text = True
                          self.current_section = 'date'
                      elif class_name == 'job-location':
                          self.capture_text = True
                          self.current_section = 'location'
                      elif tag == 'li' and 'job-description' in str(attrs):
                          self.capture_text = True
                          self.current_section = 'description'

              def handle_endtag(self, tag):
                  if tag == 'div' and self.in_first_exp and 'experience-item' in str(tag):
                      self.in_first_exp = False
                  self.capture_text = False

              def handle_data(self, data):
                  if self.capture_text:
                      text = data.strip()
                      if not text:
                          return

                      if self.current_section == 'summary':
                          self.summary = text
                      elif self.current_section == 'skill_category':
                          self.current_skill_category = text
                      elif self.current_section == 'skill_items' and self.current_skill_category:
                          self.skills[self.current_skill_category] = text
                      elif self.current_section == 'job_title':
                          self.first_experience['title'] = text
                      elif self.current_section == 'company':
                          self.first_experience['company'] = text
                      elif self.current_section == 'date':
                          self.first_experience['date'] = text
                      elif self.current_section == 'location':
                          self.first_experience['location'] = text
                      elif self.current_section == 'description':
                          if 'bullets' not in self.first_experience:
                              self.first_experience['bullets'] = []
                          self.first_experience['bullets'].append(text)
                  self.current_text = data

          # Parse HTML
          with open('resume.html', 'r') as f:
              html_content = f.read()

          parser = ResumeParser()
          parser.feed(html_content)

          # Generate README
          pdf_name = os.environ.get('PDF_NAME', 'Munevver_Aslan_Resume.pdf')

          readme = f"""# MÃ¼nevver Aslan

          **Digital Product Designer** | Lisbon, Portugal

          ðŸ“„ [Download Resume (PDF)](./{pdf_name}) | ðŸ’¼ [LinkedIn](https://linkedin.com/in/munevveraslan) | ðŸŒ [Portfolio](https://munevver.netlify.app) | âœ‰ï¸ [Email](mailto:munevveraslan2@gmail.com)

          ---

          ## ðŸ‘‹ About

          {parser.summary}

          ## ðŸ’¼ Currently

          **{parser.first_experience.get('title', '')}** at **{parser.first_experience.get('company', '')}**
          *{parser.first_experience.get('date', '')} | {parser.first_experience.get('location', '')}*

          """

          if 'bullets' in parser.first_experience:
              for bullet in parser.first_experience['bullets'][:3]:  # First 3 bullets only
                  readme += f"- {bullet}\n"

          readme += "\n## ðŸŽ¨ Skills\n\n"
          for category, items in parser.skills.items():
              readme += f"- **{category}:** {items}\n"

          readme += f"""
          ---

          ðŸ“„ **[View Full Resume (PDF)](./{pdf_name})**
          """

          with open('README.md', 'w') as f:
              f.write(readme)
          PYSCRIPT

          # Run the Python script
          python3 generate_readme.py

          # Clean up
          rm generate_readme.py

      # Configure Git for automated commits
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Check if there are changes to commit (prevents infinite loops)
      - name: Check for changes
        id: check_changes
        run: |
          git add Munevver_Aslan_Resume_*.pdf README.md
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # Commit and push artifacts only if they were modified
      - name: Commit and push artifacts
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "Auto-generate resume artifacts from resume.html"
          git push
