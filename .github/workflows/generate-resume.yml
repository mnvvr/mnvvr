name: Generate Resume Artifacts

on:
  push:
    branches: [main]
    paths:
      - 'resume-data.json'
      - 'resume-template.html'
      - 'style.css'
      - '.github/workflows/generate-resume.yml'

jobs:
  generate-artifacts:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # Checkout the repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Setup Node.js for Playwright (faster than installing Chromium via apt-get)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install Playwright with Chromium (bundled, no separate download needed)
      - name: Install Playwright
        run: |
          npm install -D playwright
          npx playwright install chromium --with-deps

      # Install Jinja2 for template rendering
      - name: Install Jinja2
        run: |
          pip install jinja2

      # Generate resume.html from template and data
      - name: Generate resume.html from template and JSON data
        run: |
          python3 << 'PYSCRIPT'
          import json
          from jinja2 import Template

          # Load resume data
          with open('resume-data.json', 'r', encoding='utf-8') as f:
              data = json.load(f)

          # Load HTML template
          with open('resume-template.html', 'r', encoding='utf-8') as f:
              template_content = f.read()

          # Render template with data
          template = Template(template_content)
          html_output = template.render(**data)

          # Write generated HTML
          with open('resume.html', 'w', encoding='utf-8') as f:
              f.write(html_output)

          print("âœ“ Generated resume.html from template and data")
          PYSCRIPT

      # Generate PDF using Playwright with commit hash in filename
      # Playwright's bundled Chromium respects print CSS and renders faster
      - name: Generate PDF from HTML
        run: |
          # Remove old versioned PDFs from git (not just filesystem)
          # The || true ensures command doesn't fail if no old PDFs exist
          git rm -f Munevver_Aslan_Resume_*.pdf 2>/dev/null || true

          COMMIT_HASH=$(git rev-parse --short=7 HEAD)
          PDF_NAME="Munevver_Aslan_Resume_${COMMIT_HASH}.pdf"

          # Create Node.js script to generate PDF with Playwright
          cat > generate-pdf.js << 'EOF'
          const { chromium } = require('playwright');
          const fs = require('fs');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto('file://' + process.cwd() + '/resume.html', { waitUntil: 'networkidle' });
            await page.pdf({
              path: process.argv[2],
              format: 'A4',
              printBackground: true,
              margin: { top: '0.35in', right: '0.35in', bottom: '0.35in', left: '0.35in' }
            });
            await browser.close();
          })();
          EOF

          # Run the PDF generation
          node generate-pdf.js "${PDF_NAME}"

          # Export PDF name for use in subsequent steps
          echo "PDF_NAME=${PDF_NAME}" >> $GITHUB_ENV

          # Clean up the temporary script
          rm generate-pdf.js

      # Generate clean, visually organized README from JSON data
      # Much simpler than HTML parsing - reads directly from the data source
      - name: Generate clean markdown README from JSON
        run: |
          python3 << 'PYSCRIPT'
          import json
          import os

          # Load resume data from JSON
          with open('resume-data.json', 'r', encoding='utf-8') as f:
              data = json.load(f)

          # Get PDF name from environment
          pdf_name = os.environ.get('PDF_NAME', 'Munevver_Aslan_Resume.pdf')

          # Extract data for README
          personal = data['personal']
          summary = data['summary']
          skills = data['skills']
          current_job = data['experience'][0]  # First job is the latest

          # Generate README with clean formatting
          readme = f"""# {personal['firstName']} {personal['lastName']}

          **{personal['title']}** | {personal['location']}

          ðŸ“„ [Download Resume (PDF)](./{pdf_name}) | ðŸ’¼ [LinkedIn](https://linkedin.com/in/{personal['linkedin']}) | ðŸŒ [Portfolio]({personal['portfolio']}) | âœ‰ï¸ [Email](mailto:{personal['email']})

          ---

          ## ðŸ‘‹ About

          {summary}

          ## ðŸ’¼ Currently

          **{current_job['title']}** at **{current_job['company']}**
          *{current_job['date']} | {current_job['location']}*

          """

          # Add first 3 bullets from current job
          for bullet in current_job['bullets'][:3]:
              readme += f"- {bullet}\n"

          # Add skills section
          readme += "\n## ðŸŽ¨ Skills\n\n"
          for skill in skills:
              readme += f"- **{skill['category']}:** {skill['items']}\n"

          # Add footer
          readme += f"""
          ---

          ðŸ“„ **[View Full Resume (PDF)](./{pdf_name})**
          """

          # Write README
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(readme)

          print("âœ“ Generated README.md from JSON data")
          PYSCRIPT

      # Configure Git for automated commits
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Check if there are changes to commit (prevents infinite loops)
      - name: Check for changes
        id: check_changes
        run: |
          git add resume.html Munevver_Aslan_Resume_*.pdf README.md
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # Commit and push artifacts only if they were modified
      - name: Commit and push artifacts
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "Auto-generate resume artifacts from resume-data.json"
          git push
