name: Generate Resume Artifacts

on:
  push:
    branches: [main]
    paths:
      - 'resume.html'
      - 'style.css'
      - '.github/workflows/generate-resume.yml'

jobs:
  generate-artifacts:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # Checkout the repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Install Pandoc for HTML to Markdown conversion
      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      # Install Chromium for PDF generation with print CSS support
      - name: Install Chromium
        run: |
          sudo apt-get install -y chromium-browser

      # Generate PDF using Chromium headless with commit hash in filename
      # Chromium respects print-specific CSS and paged media better than Weasyprint for HTML
      - name: Generate PDF from HTML
        run: |
          COMMIT_HASH=$(git rev-parse --short=7 HEAD)
          PDF_NAME="Munevver_Aslan_Resume_${COMMIT_HASH}.pdf"
          chromium-browser --headless --disable-gpu \
            --print-to-pdf="${PDF_NAME}" \
            --no-pdf-header-footer \
            --print-to-pdf-no-header \
            resume.html
          # Create symlink for latest version
          ln -sf "${PDF_NAME}" Munevver_Aslan_Resume.pdf

      # Generate styled README.md with embedded HTML resume
      # GitHub supports HTML in markdown, preserving visual styling
      - name: Generate styled README from HTML
        run: |
          cat > README.md << 'README_EOF'
          <div align="center">

          # MÃ¼nevver Aslan

          **Digital Product Designer** | Lisbon, Portugal

          ğŸ“„ [Download PDF Resume](./Munevver_Aslan_Resume.pdf) | ğŸ’¼ [LinkedIn](https://linkedin.com/in/munevveraslan) | ğŸŒ [Portfolio](https://munevver.netlify.app)

          </div>

          ---

          README_EOF

          # Extract the body content and embed with style tag
          sed -n '/<body>/,/<\/body>/p' resume.html | \
          sed '1d;$d' | \
          sed 's|<link rel="stylesheet" href="style.css">||' >> README.md

          # Prepend inline styles from style.css
          echo "<style>" > temp_readme.md
          cat style.css >> temp_readme.md
          echo "</style>" >> temp_readme.md
          echo "" >> temp_readme.md
          cat README.md >> temp_readme.md
          mv temp_readme.md README.md

      # Configure Git for automated commits
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Check if there are changes to commit (prevents infinite loops)
      - name: Check for changes
        id: check_changes
        run: |
          git add Munevver_Aslan_Resume_*.pdf Munevver_Aslan_Resume.pdf README.md
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # Commit and push artifacts only if they were modified
      - name: Commit and push artifacts
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "Auto-generate resume artifacts from resume.html"
          git push
