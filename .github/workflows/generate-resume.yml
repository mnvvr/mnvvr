name: Generate Resume Artifacts

on:
  push:
    branches: [main]
    paths:
      - 'resume.html'
      - 'style.css'
      - 'readme.css'
      - '.github/workflows/generate-resume.yml'

jobs:
  generate-artifacts:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # Checkout the repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Install Pandoc for HTML to Markdown conversion
      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      # Install Chromium for PDF generation with print CSS support
      - name: Install Chromium
        run: |
          sudo apt-get install -y chromium-browser

      # Generate PDF using Chromium headless with commit hash in filename
      # Chromium respects print-specific CSS and paged media better than Weasyprint for HTML
      - name: Generate PDF from HTML
        run: |
          # Remove old versioned PDFs to keep only the latest
          rm -f Munevver_Aslan_Resume_*.pdf

          COMMIT_HASH=$(git rev-parse --short=7 HEAD)
          PDF_NAME="Munevver_Aslan_Resume_${COMMIT_HASH}.pdf"
          chromium-browser --headless --disable-gpu \
            --print-to-pdf="${PDF_NAME}" \
            --no-pdf-header-footer \
            --print-to-pdf-no-header \
            resume.html
          # Create symlink for latest version
          ln -sf "${PDF_NAME}" Munevver_Aslan_Resume.pdf

      # Generate clean markdown README from HTML using Pandoc
      # GitHub-flavored markdown renders beautifully without custom CSS
      - name: Generate clean markdown README from HTML
        run: |
          # Create header section with links
          cat > README.md << 'README_HEADER'
          # MÃ¼nevver Aslan

          **Digital Product Designer** | Lisbon, Portugal

          ðŸ“„ [Download Resume (PDF)](./Munevver_Aslan_Resume.pdf) | ðŸ’¼ [LinkedIn](https://linkedin.com/in/munevveraslan) | ðŸŒ [Portfolio](https://munevver.netlify.app) | âœ‰ï¸ [Email](mailto:munevveraslan2@gmail.com)

          ---

          README_HEADER

          # Convert HTML to markdown, stripping all div/span classes but keeping content
          pandoc resume.html -f html -t gfm --wrap=none >> README.md

      # Configure Git for automated commits
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Check if there are changes to commit (prevents infinite loops)
      - name: Check for changes
        id: check_changes
        run: |
          git add Munevver_Aslan_Resume_*.pdf Munevver_Aslan_Resume.pdf README.md
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # Commit and push artifacts only if they were modified
      - name: Commit and push artifacts
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "Auto-generate resume artifacts from resume.html"
          git push
