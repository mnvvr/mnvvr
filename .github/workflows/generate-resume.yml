name: Generate Resume Artifacts

on:
  push:
    branches: [main]
    paths:
      - 'resume.html'
      - 'style.css'
      - '.github/workflows/generate-resume.yml'

jobs:
  generate-artifacts:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # Checkout the repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Setup Node.js for Playwright (faster than installing Chromium via apt-get)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install Playwright with Chromium (bundled, no separate download needed)
      - name: Install Playwright
        run: |
          npm install -D playwright
          npx playwright install chromium --with-deps

      # Install Pandoc for HTML to Markdown conversion
      - name: Install Pandoc
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y pandoc

      # Generate PDF using Playwright with commit hash in filename
      # Playwright's bundled Chromium respects print CSS and renders faster
      - name: Generate PDF from HTML
        run: |
          # Remove old versioned PDFs from git (not just filesystem)
          # The || true ensures command doesn't fail if no old PDFs exist
          git rm -f Munevver_Aslan_Resume_*.pdf 2>/dev/null || true

          COMMIT_HASH=$(git rev-parse --short=7 HEAD)
          PDF_NAME="Munevver_Aslan_Resume_${COMMIT_HASH}.pdf"

          # Create Node.js script to generate PDF with Playwright
          cat > generate-pdf.js << 'EOF'
          const { chromium } = require('playwright');
          const fs = require('fs');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto('file://' + process.cwd() + '/resume.html', { waitUntil: 'networkidle' });
            await page.pdf({
              path: process.argv[2],
              format: 'A4',
              printBackground: true,
              margin: { top: '0.35in', right: '0.35in', bottom: '0.35in', left: '0.35in' }
            });
            await browser.close();
          })();
          EOF

          # Run the PDF generation
          node generate-pdf.js "${PDF_NAME}"

          # Create symlink for latest version
          ln -sf "${PDF_NAME}" Munevver_Aslan_Resume.pdf

          # Clean up the temporary script
          rm generate-pdf.js

      # Generate clean markdown README from HTML using Pandoc
      # GitHub-flavored markdown renders beautifully without custom CSS
      - name: Generate clean markdown README from HTML
        run: |
          # Create header section with links
          cat > README.md << 'README_HEADER'
          # MÃ¼nevver Aslan

          **Digital Product Designer** | Lisbon, Portugal

          ðŸ“„ [Download Resume (PDF)](./Munevver_Aslan_Resume.pdf) | ðŸ’¼ [LinkedIn](https://linkedin.com/in/munevveraslan) | ðŸŒ [Portfolio](https://munevver.netlify.app) | âœ‰ï¸ [Email](mailto:munevveraslan2@gmail.com)

          ---

          README_HEADER

          # Convert HTML to markdown, stripping all div/span classes but keeping content
          pandoc resume.html -f html -t gfm --wrap=none >> README.md

      # Configure Git for automated commits
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Check if there are changes to commit (prevents infinite loops)
      - name: Check for changes
        id: check_changes
        run: |
          git add Munevver_Aslan_Resume_*.pdf Munevver_Aslan_Resume.pdf README.md
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # Commit and push artifacts only if they were modified
      - name: Commit and push artifacts
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "Auto-generate resume artifacts from resume.html"
          git push
